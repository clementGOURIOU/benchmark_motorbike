#!/bin/bash
#

. $WM_PROJECT_DIR/bin/tools/RunFunctions

#We stop this script when we encounter a problem
trap "exit -1" ERR

rootFolder="../../"
export caseName=`basename $PWD`

runApplication -s calcIterTimeStats python3 calcIterTimeStats.py log.XiFoam

echo "$caseName: copy the postProcessing folder from $rootFolder"
cp -r $rootFolder/postProcessing .

runApplication reconstructPar -latestTime

echo "$caseName: Postprocessing"
cd postProcessing

# Find latest time directory
latestAvailTimeDir=`foamListTimes -case .. | tail -1`

echo "Analysing results for time: $latestAvailTimeDir"

# Run sample
runApplication postProcess -func sampleDict -case .. -latestTime

# Adjust compareAll.gplt: replace "Computed" "??" by "Computed" "$latestAvailTimeDir"
sed -i "s/\"Computed\".*$/\"Computed\" \"$latestAvailTimeDir\"/g" compareAll.gplt

# Run gnuplot to generate the comparison charts
runApplication -s compareAll gnuplot compareAll.gplt

# Run foamLog
runApplication foamLog ../log.XiFoam

# Run gnuplot for the residuals
runApplication -s plotResiduals gnuplot plotResiduals.gplt
